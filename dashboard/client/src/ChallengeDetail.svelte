<script>
  import { marked } from 'marked';
  import { isLoading, loadSingleCampaign, setChallengeRunning } from './stores';

  export let challenge;

  async function flagSubmit(task) {
    console.log(task);

    let payload = {
      challenge_id: challenge.id,
      task_id: task.id,
      flag: task.flag,
    };

    try {
      const res = await fetch(`/api/challenges/submit`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });
      const data = await res.text();

      if (res.status !== 200) {
        throw new Error(`Error: request failed with HTTP status ${res.status}: ${await res.text()}`);
      }

      if (data.includes('Congratulations')) {
        task.solved = true;
        challenge.tasks = challenge.tasks; // Reassign to trigger reactivity
      }
      alert(data);
      if (task.solved && challenge.campaignId) {
        loadSingleCampaign(challenge.campaignId).then();
      }
    } catch (err) {
      console.error(err);
      alert(err instanceof Error ? err.message : err);
    }
  }

  async function flipActivity() {
    isLoading.set(true);
    try {
      let payload = {
        challenge_id: challenge.id,
      };
      const action = challenge.running === true ? 'stop' : 'start';
      const res = await fetch(`/api/challenges/${action}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });
      if (res.status !== 200) {
        throw new Error(`Error: request failed with HTTP status ${res.status}: ${await res.text()}`);
      }

      setChallengeRunning(challenge.id, challenge.campaignId, action === 'start');
    } catch (err) {
      console.error(err);
      alert(err instanceof Error ? err.message : err);
    }
    isLoading.set(false);
  }
</script>

<style>
  .slow-spinner {
    animation-duration: 1.5s;
  }
</style>

<div class="ms-2 d-flex justify-content-between align-items-center">
  <div>
    <h4 class="d-inline">{challenge.name}</h4>
  </div>
</div>
<div class="pt-3 text-muted">
  <!-- eslint-disable-next-line svelte/no-at-html-tags -- render the description -->
  {@html marked(challenge.description)}
</div>

<div
  class="alert me-2 d-flex justify-content-between align-items-center {challenge.running
    ? 'alert-success'
    : 'alert-light'}"
  role="alert"
>
  <div class="d-flex align-items-center">
    {#if challenge.running}
      <div class="spinner-grow text-success me-2 slow-spinner" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <span>The challenge is up and running!</span>
    {:else}
      <span>The challenge is not running</span>
    {/if}
  </div>

  <button class="btn {!challenge.running ? 'btn-primary' : 'btn-secondary'} ms-auto" on:click={flipActivity}>
    {challenge.running ? 'Stop' : 'Start'}
  </button>
</div>

{#each challenge['tasks'] as task}
  <div class="card {task.solved ? 'border-success' : ''} mb-3 me-2">
    <div class="card-header {task.solved ? 'bg-success-subtle' : ''}">
      {task.name}
    </div>
    <div class="card-body">
      <div class="card-text mb-3">
        <!-- eslint-disable-next-line svelte/no-at-html-tags -- render the description -->
        {@html marked.parse(task.description)}
      </div>

      <div class="input-group mb-3">
        <span class="input-group-text" id="basic-addon1">Flag: </span>
        <input disabled={!challenge.running} type="text" bind:value={task.flag} class="form-control" />
        <button
          disabled={!challenge.running}
          class="btn btn-outline-secondary"
          on:click={() => flagSubmit(task)}
          type="button">Submit</button
        >
      </div>
    </div>
  </div>
{/each}
